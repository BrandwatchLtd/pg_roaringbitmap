--
--  Test roaringbitmap extension
--
CREATE EXTENSION roaringbitmap;
-- Test input and output
select  '{}'::roaringbitmap;
 roaringbitmap 
---------------
 {}
(1 row)

select  '  { 	 }  '::roaringbitmap;
 roaringbitmap 
---------------
 {}
(1 row)

select  '{	1 }'::roaringbitmap;
 roaringbitmap 
---------------
 {1}
(1 row)

select  '{-1,2,555555,-4}'::roaringbitmap;
  roaringbitmap   
------------------
 {2,555555,-4,-1}
(1 row)

select  '{ -1 ,  2  , 555555 ,  -4  }'::roaringbitmap;
  roaringbitmap   
------------------
 {2,555555,-4,-1}
(1 row)

select  '{ 1 ,  -2  , 555555 ,  -4  }'::roaringbitmap;
  roaringbitmap   
------------------
 {1,555555,-4,-2}
(1 row)

select  '{ 1 ,  -2  , 555555 ,  -4  ,2147483647,-2147483648}'::roaringbitmap;
              roaringbitmap              
-----------------------------------------
 {1,555555,2147483647,-2147483648,-4,-2}
(1 row)

select  roaringbitmap('{ 1 ,  -2  , 555555 ,  -4  }');
  roaringbitmap   
------------------
 {1,555555,-4,-2}
(1 row)

-- Exception
select  ''::roaringbitmap;
ERROR:  malformed bitmap literal
LINE 1: select  ''::roaringbitmap;
                ^
select  '{'::roaringbitmap;
ERROR:  malformed bitmap literal
LINE 1: select  '{'::roaringbitmap;
                ^
select  '{1'::roaringbitmap;
ERROR:  malformed bitmap literal
LINE 1: select  '{1'::roaringbitmap;
                ^
select  '{1} x'::roaringbitmap;
ERROR:  malformed bitmap literal
LINE 1: select  '{1} x'::roaringbitmap;
                ^
select  '{1x}'::roaringbitmap;
ERROR:  malformed bitmap literal
LINE 1: select  '{1x}'::roaringbitmap;
                ^
select  '{-x}'::roaringbitmap;
ERROR:  invalid input syntax for integer: "-x}"
LINE 1: select  '{-x}'::roaringbitmap;
                ^
select  '{,}'::roaringbitmap;
ERROR:  invalid input syntax for integer: ",}"
LINE 1: select  '{,}'::roaringbitmap;
                ^
select  '{1,}'::roaringbitmap;
ERROR:  invalid input syntax for integer: "}"
LINE 1: select  '{1,}'::roaringbitmap;
                ^
select  '{1,xxx}'::roaringbitmap;
ERROR:  invalid input syntax for integer: "xxx}"
LINE 1: select  '{1,xxx}'::roaringbitmap;
                ^
select  '{1,3'::roaringbitmap;
ERROR:  malformed bitmap literal
LINE 1: select  '{1,3'::roaringbitmap;
                ^
select  '{1,1'::roaringbitmap;
ERROR:  malformed bitmap literal
LINE 1: select  '{1,1'::roaringbitmap;
                ^
select  '{1,-2147483649}'::roaringbitmap;
ERROR:  value "-2147483649}" is out of range for type integer
LINE 1: select  '{1,-2147483649}'::roaringbitmap;
                ^
select  '{2147483648}'::roaringbitmap;
ERROR:  value "2147483648}" is out of range for type integer
LINE 1: select  '{2147483648}'::roaringbitmap;
                ^
-- Test Opperator
select roaringbitmap('{}') & roaringbitmap('{}');
 ?column? 
----------
 {}
(1 row)

select roaringbitmap('{}') & roaringbitmap('{3,4,5}');
 ?column? 
----------
 {}
(1 row)

select roaringbitmap('{1,2,3}') & roaringbitmap('{}');
 ?column? 
----------
 {}
(1 row)

select roaringbitmap('{1,2,3}') & roaringbitmap('{3,4,5}');
 ?column? 
----------
 {3}
(1 row)

select roaringbitmap('{1,-2,-3}') & roaringbitmap('{-3,-4,5}');
 ?column? 
----------
 {-3}
(1 row)

select roaringbitmap('{}') | roaringbitmap('{}');
 ?column? 
----------
 {}
(1 row)

select roaringbitmap('{}') | roaringbitmap('{3,4,5}');
 ?column? 
----------
 {3,4,5}
(1 row)

select roaringbitmap('{1,2,3}') | roaringbitmap('{}');
 ?column? 
----------
 {1,2,3}
(1 row)

select roaringbitmap('{1,2,3}') | roaringbitmap('{3,4,5}');
  ?column?   
-------------
 {1,2,3,4,5}
(1 row)

select roaringbitmap('{1,-2,-3}') | roaringbitmap('{-3,-4,5}');
    ?column?    
----------------
 {1,5,-4,-3,-2}
(1 row)

select roaringbitmap('{}') | 6;
 ?column? 
----------
 {6}
(1 row)

select roaringbitmap('{1,2,3}') | 6;
 ?column?  
-----------
 {1,2,3,6}
(1 row)

select roaringbitmap('{1,2,3}') | 1;
 ?column? 
----------
 {1,2,3}
(1 row)

select roaringbitmap('{1,2,3}') | -1;
  ?column?  
------------
 {1,2,3,-1}
(1 row)

select roaringbitmap('{-1,-2,3}') | -1;
 ?column?  
-----------
 {3,-2,-1}
(1 row)

select 6 | roaringbitmap('{}');
 ?column? 
----------
 {6}
(1 row)

select 6 | roaringbitmap('{1,2,3}');
 ?column?  
-----------
 {1,2,3,6}
(1 row)

select 1 | roaringbitmap('{1,2,3}');
 ?column? 
----------
 {1,2,3}
(1 row)

select -1 | roaringbitmap('{1,2,3}');
  ?column?  
------------
 {1,2,3,-1}
(1 row)

select -1 | roaringbitmap('{-1,-2,3}');
 ?column?  
-----------
 {3,-2,-1}
(1 row)

select roaringbitmap('{}') # roaringbitmap('{}');
 ?column? 
----------
 {}
(1 row)

select roaringbitmap('{}') # roaringbitmap('{3,4,5}');
 ?column? 
----------
 {3,4,5}
(1 row)

select roaringbitmap('{1,2,3}') # roaringbitmap('{}');
 ?column? 
----------
 {1,2,3}
(1 row)

select roaringbitmap('{1,2,3}') # roaringbitmap('{3,4,5}');
 ?column?  
-----------
 {1,2,4,5}
(1 row)

select roaringbitmap('{1,-2,-3}') # roaringbitmap('{-3,-4,5}');
  ?column?   
-------------
 {1,5,-4,-2}
(1 row)

select roaringbitmap('{}') - roaringbitmap('{}');
 ?column? 
----------
 {}
(1 row)

select roaringbitmap('{}') - roaringbitmap('{3,4,5}');
 ?column? 
----------
 {}
(1 row)

select roaringbitmap('{1,2,3}') - roaringbitmap('{}');
 ?column? 
----------
 {1,2,3}
(1 row)

select roaringbitmap('{1,2,3}') - roaringbitmap('{3,4,5}');
 ?column? 
----------
 {1,2}
(1 row)

select roaringbitmap('{1,-2,-3}') - roaringbitmap('{-3,-4,5}');
 ?column? 
----------
 {1,-2}
(1 row)

select roaringbitmap('{}') - 3;
 ?column? 
----------
 {}
(1 row)

select roaringbitmap('{1,2,3}') - 3;
 ?column? 
----------
 {1,2}
(1 row)

select roaringbitmap('{1,2,3}') - 1;
 ?column? 
----------
 {2,3}
(1 row)

select roaringbitmap('{1,2,3}') - -1;
 ?column? 
----------
 {1,2,3}
(1 row)

select roaringbitmap('{-1,-2,3}') - -1;
 ?column? 
----------
 {3,-2}
(1 row)

select roaringbitmap('{}') << 2;
 ?column? 
----------
 {}
(1 row)

select roaringbitmap('{-2,-1,0,1,2,3,2147483647,-2147483648}') << 2;
             ?column?              
-----------------------------------
 {0,1,2147483645,2147483646,-4,-3}
(1 row)

select roaringbitmap('{-2,-1,0,1,2,3,2147483647,-2147483648}') << 1;
              ?column?               
-------------------------------------
 {0,1,2,2147483646,2147483647,-3,-2}
(1 row)

select roaringbitmap('{-2,-1,0,1,2,3,2147483647,-2147483648}') << 0;
                ?column?                
----------------------------------------
 {0,1,2,3,2147483647,-2147483648,-2,-1}
(1 row)

select roaringbitmap('{-2,-1,0,1,2,3,2147483647,-2147483648}') << -1;
               ?column?               
--------------------------------------
 {1,2,3,4,-2147483648,-2147483647,-1}
(1 row)

select roaringbitmap('{-2,-1,0,1,2,3,2147483647,-2147483648}') << -2;
             ?column?              
-----------------------------------
 {2,3,4,5,-2147483647,-2147483646}
(1 row)

select roaringbitmap('{-2,-1,0,1,2,3,2147483647,-2147483648}') << 4294967295;
 ?column? 
----------
 {0}
(1 row)

select roaringbitmap('{-2,-1,0,1,2,3,2147483647,-2147483648}') << 4294967296;
 ?column? 
----------
 {}
(1 row)

select roaringbitmap('{-2,-1,0,1,2,3,2147483647,-2147483648}') << -4294967295;
 ?column? 
----------
 {-1}
(1 row)

select roaringbitmap('{-2,-1,0,1,2,3,2147483647,-2147483648}') << -4294967296;
 ?column? 
----------
 {}
(1 row)

select roaringbitmap('{}') >> 2;
 ?column? 
----------
 {}
(1 row)

select roaringbitmap('{-2,-1,0,1,2,3,2147483647,-2147483648}') >> 2;
             ?column?              
-----------------------------------
 {2,3,4,5,-2147483647,-2147483646}
(1 row)

select roaringbitmap('{-2,-1,0,1,2,3,2147483647,-2147483648}') >> 1;
               ?column?               
--------------------------------------
 {1,2,3,4,-2147483648,-2147483647,-1}
(1 row)

select roaringbitmap('{-2,-1,0,1,2,3,2147483647,-2147483648}') >> 0;
                ?column?                
----------------------------------------
 {0,1,2,3,2147483647,-2147483648,-2,-1}
(1 row)

select roaringbitmap('{-2,-1,0,1,2,3,2147483647,-2147483648}') >> -1;
              ?column?               
-------------------------------------
 {0,1,2,2147483646,2147483647,-3,-2}
(1 row)

select roaringbitmap('{-2,-1,0,1,2,3,2147483647,-2147483648}') >> -2;
             ?column?              
-----------------------------------
 {0,1,2147483645,2147483646,-4,-3}
(1 row)

select roaringbitmap('{-2,-1,0,1,2,3,2147483647,-2147483648}') >> 4294967295;
 ?column? 
----------
 {-1}
(1 row)

select roaringbitmap('{-2,-1,0,1,2,3,2147483647,-2147483648}') >> 4294967296;
 ?column? 
----------
 {}
(1 row)

select roaringbitmap('{-2,-1,0,1,2,3,2147483647,-2147483648}') >> -4294967295;
 ?column? 
----------
 {0}
(1 row)

select roaringbitmap('{-2,-1,0,1,2,3,2147483647,-2147483648}') >> -4294967296;
 ?column? 
----------
 {}
(1 row)

select roaringbitmap('{}') @> roaringbitmap('{}');
 ?column? 
----------
 t
(1 row)

select roaringbitmap('{}') @> roaringbitmap('{3,4,5}');
 ?column? 
----------
 f
(1 row)

select roaringbitmap('{1,2,3}') @> roaringbitmap('{}');
 ?column? 
----------
 t
(1 row)

select roaringbitmap('{1,2,3}') @> roaringbitmap('{3,4,5}');
 ?column? 
----------
 f
(1 row)

select roaringbitmap('{1,2,3}') @> roaringbitmap('{3,2}');
 ?column? 
----------
 t
(1 row)

select roaringbitmap('{1,-2,-3}')  @> roaringbitmap('{-3,1}');
 ?column? 
----------
 t
(1 row)

select roaringbitmap('{}') @> 2;
 ?column? 
----------
 f
(1 row)

select roaringbitmap('{1,2,3}') @> 20;
 ?column? 
----------
 f
(1 row)

select roaringbitmap('{1,2,3}') @> 1;
 ?column? 
----------
 t
(1 row)

select roaringbitmap('{1,2,3}') @> -1;
 ?column? 
----------
 f
(1 row)

select roaringbitmap('{-1,-2,3}') @> -1;
 ?column? 
----------
 t
(1 row)

select roaringbitmap('{}') <@ roaringbitmap('{}');
 ?column? 
----------
 t
(1 row)

select roaringbitmap('{}') <@ roaringbitmap('{3,4,5}');
 ?column? 
----------
 t
(1 row)

select roaringbitmap('{1,2,3}') <@ roaringbitmap('{}');
 ?column? 
----------
 f
(1 row)

select roaringbitmap('{1,2,3}') <@ roaringbitmap('{3,4,5}');
 ?column? 
----------
 f
(1 row)

select roaringbitmap('{2,3}') <@ roaringbitmap('{1,3,2}');
 ?column? 
----------
 t
(1 row)

select roaringbitmap('{1,-3}')  <@ roaringbitmap('{-3,1,1000}');
 ?column? 
----------
 t
(1 row)

select 6 <@ roaringbitmap('{}');
 ?column? 
----------
 f
(1 row)

select 3 <@ roaringbitmap('{1,2,3}');
 ?column? 
----------
 t
(1 row)

select 1 <@ roaringbitmap('{1,2,3}');
 ?column? 
----------
 t
(1 row)

select -1 <@ roaringbitmap('{1,2,3}');
 ?column? 
----------
 f
(1 row)

select -1 <@ roaringbitmap('{-1,-2,3}');
 ?column? 
----------
 t
(1 row)

select roaringbitmap('{}') && roaringbitmap('{}');
 ?column? 
----------
 f
(1 row)

select roaringbitmap('{}') && roaringbitmap('{3,4,5}');
 ?column? 
----------
 f
(1 row)

select roaringbitmap('{1,2,3}') && roaringbitmap('{}');
 ?column? 
----------
 f
(1 row)

select roaringbitmap('{1,2,3}') && roaringbitmap('{3,4,5}');
 ?column? 
----------
 t
(1 row)

select roaringbitmap('{1,-2,-3}') && roaringbitmap('{-3,-4,5}');
 ?column? 
----------
 t
(1 row)

select roaringbitmap('{}') = roaringbitmap('{}');
 ?column? 
----------
 t
(1 row)

select roaringbitmap('{}') = roaringbitmap('{3,4,5}');
 ?column? 
----------
 f
(1 row)

select roaringbitmap('{1,2,3}') = roaringbitmap('{}');
 ?column? 
----------
 f
(1 row)

select roaringbitmap('{1,2,3}') = roaringbitmap('{3,1,2}');
 ?column? 
----------
 t
(1 row)

select roaringbitmap('{1,-2,-3}') = roaringbitmap('{-3,-4,5}');
 ?column? 
----------
 f
(1 row)

select roaringbitmap('{}') <> roaringbitmap('{}');
 ?column? 
----------
 f
(1 row)

select roaringbitmap('{}') <> roaringbitmap('{3,4,5}');
 ?column? 
----------
 t
(1 row)

select roaringbitmap('{1,2,3}') <> roaringbitmap('{}');
 ?column? 
----------
 t
(1 row)

select roaringbitmap('{1,2,3}') <> roaringbitmap('{3,1,2}');
 ?column? 
----------
 f
(1 row)

select roaringbitmap('{1,-2,-3}') <> roaringbitmap('{-3,-4,5}');
 ?column? 
----------
 t
(1 row)

-- Test the functions with one bitmap variable
select rb_build(NULL);
 rb_build 
----------
 
(1 row)

select rb_build('{}'::int[]);
 rb_build 
----------
 {}
(1 row)

select rb_build('{1}'::int[]);
 rb_build 
----------
 {1}
(1 row)

select rb_build('{-1,2,555555,-4}'::int[]);
     rb_build     
------------------
 {2,555555,-4,-1}
(1 row)

select rb_build('{1,-2,555555,-4,2147483647,-2147483648}'::int[]);
                rb_build                 
-----------------------------------------
 {1,555555,2147483647,-2147483648,-4,-2}
(1 row)

select rb_to_array(NULL);
 rb_to_array 
-------------
 
(1 row)

select rb_to_array('{}'::roaringbitmap);
 rb_to_array 
-------------
 {}
(1 row)

select rb_to_array('{1}'::roaringbitmap);
 rb_to_array 
-------------
 {1}
(1 row)

select rb_to_array('{-1,2,555555,-4}'::roaringbitmap);
   rb_to_array    
------------------
 {2,555555,-4,-1}
(1 row)

select rb_to_array('{1,-2,555555,-4,2147483647,-2147483648}'::roaringbitmap);
               rb_to_array               
-----------------------------------------
 {1,555555,2147483647,-2147483648,-4,-2}
(1 row)

select rb_is_empty(NULL);
 rb_is_empty 
-------------
 
(1 row)

select rb_is_empty('{}');
 rb_is_empty 
-------------
 t
(1 row)

select rb_is_empty('{1}');
 rb_is_empty 
-------------
 f
(1 row)

select rb_is_empty('{1,10,100}');
 rb_is_empty 
-------------
 f
(1 row)

select rb_cardinality(NULL);
 rb_cardinality 
----------------
               
(1 row)

select rb_cardinality('{}');
 rb_cardinality 
----------------
              0
(1 row)

select rb_cardinality('{1}');
 rb_cardinality 
----------------
              1
(1 row)

select rb_cardinality('{1,10,100}');
 rb_cardinality 
----------------
              3
(1 row)

select rb_max(NULL);
 rb_max 
--------
       
(1 row)

select rb_max('{}');
 rb_max 
--------
       
(1 row)

select rb_max('{1}');
 rb_max 
--------
      1
(1 row)

select rb_max('{1,10,100}');
 rb_max 
--------
    100
(1 row)

select rb_max('{1,10,100,2147483647,-2147483648,-1}');
 rb_max 
--------
     -1
(1 row)

select rb_min(NULL);
 rb_min 
--------
       
(1 row)

select rb_min('{}');
 rb_min 
--------
       
(1 row)

select rb_min('{1}');
 rb_min 
--------
      1
(1 row)

select rb_min('{1,10,100}');
 rb_min 
--------
      1
(1 row)

select rb_min('{1,10,100,2147483647,-2147483648,-1}');
 rb_min 
--------
      1
(1 row)

-- Test the functions with two bitmap variables
select rb_and(NULL,'{1,10,100}');
 rb_and 
--------
 
(1 row)

select rb_and('{1,10,100}',NULL);
 rb_and 
--------
 
(1 row)

select rb_and('{}','{1,10,100}');
 rb_and 
--------
 {}
(1 row)

select rb_and('{1,10,100}','{}');
 rb_and 
--------
 {}
(1 row)

select rb_and('{2}','{1,10,100}');
 rb_and 
--------
 {}
(1 row)

select rb_and('{1,2,10}','{1,10,100}');
 rb_and 
--------
 {1,10}
(1 row)

select rb_and('{1,10}','{1,10,100}');
 rb_and 
--------
 {1,10}
(1 row)

select rb_and_cardinality(NULL,'{1,10,100}');
 rb_and_cardinality 
--------------------
                   
(1 row)

select rb_and_cardinality('{1,10,100}',NULL);
 rb_and_cardinality 
--------------------
                   
(1 row)

select rb_and_cardinality('{}','{1,10,100}');
 rb_and_cardinality 
--------------------
                  0
(1 row)

select rb_and_cardinality('{1,10,100}','{}');
 rb_and_cardinality 
--------------------
                  0
(1 row)

select rb_and_cardinality('{2}','{1,10,100}');
 rb_and_cardinality 
--------------------
                  0
(1 row)

select rb_and_cardinality('{1,2,10}','{1,10,100}');
 rb_and_cardinality 
--------------------
                  2
(1 row)

select rb_and_cardinality('{1,10}','{1,10,100}');
 rb_and_cardinality 
--------------------
                  2
(1 row)

select rb_or(NULL,'{1,10,100}');
 rb_or 
-------
 
(1 row)

select rb_or('{1,10,100}',NULL);
 rb_or 
-------
 
(1 row)

select rb_or('{}','{1,10,100}');
   rb_or    
------------
 {1,10,100}
(1 row)

select rb_or('{1,10,100}','{}');
   rb_or    
------------
 {1,10,100}
(1 row)

select rb_or('{2}','{1,10,100}');
    rb_or     
--------------
 {1,2,10,100}
(1 row)

select rb_or('{1,2,10}','{1,10,100}');
    rb_or     
--------------
 {1,2,10,100}
(1 row)

select rb_or('{1,10}','{1,10,100}');
   rb_or    
------------
 {1,10,100}
(1 row)

select rb_or_cardinality(NULL,'{1,10,100}');
 rb_or_cardinality 
-------------------
                  
(1 row)

select rb_or_cardinality('{1,10,100}',NULL);
 rb_or_cardinality 
-------------------
                  
(1 row)

select rb_or_cardinality('{}','{1,10,100}');
 rb_or_cardinality 
-------------------
                 3
(1 row)

select rb_or_cardinality('{1,10,100}','{}');
 rb_or_cardinality 
-------------------
                 3
(1 row)

select rb_or_cardinality('{2}','{1,10,100}');
 rb_or_cardinality 
-------------------
                 4
(1 row)

select rb_or_cardinality('{1,2,10}','{1,10,100}');
 rb_or_cardinality 
-------------------
                 4
(1 row)

select rb_or_cardinality('{1,10}','{1,10,100}');
 rb_or_cardinality 
-------------------
                 3
(1 row)

select rb_xor(NULL,'{1,10,100}');
 rb_xor 
--------
 
(1 row)

select rb_xor('{1,10,100}',NULL);
 rb_xor 
--------
 
(1 row)

select rb_xor('{}','{1,10,100}');
   rb_xor   
------------
 {1,10,100}
(1 row)

select rb_xor('{1,10,100}','{}');
   rb_xor   
------------
 {1,10,100}
(1 row)

select rb_xor('{2}','{1,10,100}');
    rb_xor    
--------------
 {1,2,10,100}
(1 row)

select rb_xor('{1,2,10}','{1,10,100}');
 rb_xor  
---------
 {2,100}
(1 row)

select rb_xor('{1,10}','{1,10,100}');
 rb_xor 
--------
 {100}
(1 row)

select rb_xor_cardinality(NULL,'{1,10,100}');
 rb_xor_cardinality 
--------------------
                   
(1 row)

select rb_xor_cardinality('{1,10,100}',NULL);
 rb_xor_cardinality 
--------------------
                   
(1 row)

select rb_xor_cardinality('{}','{1,10,100}');
 rb_xor_cardinality 
--------------------
                  3
(1 row)

select rb_xor_cardinality('{1,10,100}','{}');
 rb_xor_cardinality 
--------------------
                  3
(1 row)

select rb_xor_cardinality('{2}','{1,10,100}');
 rb_xor_cardinality 
--------------------
                  4
(1 row)

select rb_xor_cardinality('{1,2,10}','{1,10,100}');
 rb_xor_cardinality 
--------------------
                  2
(1 row)

select rb_xor_cardinality('{1,10}','{1,10,100}');
 rb_xor_cardinality 
--------------------
                  1
(1 row)

select rb_equals(NULL,'{1,10,100}');
 rb_equals 
-----------
 
(1 row)

select rb_equals('{1,10,100}',NULL);
 rb_equals 
-----------
 
(1 row)

select rb_equals('{}','{1,10,100}');
 rb_equals 
-----------
 f
(1 row)

select rb_equals('{1,10,100}','{}');
 rb_equals 
-----------
 f
(1 row)

select rb_equals('{2}','{1,10,100}');
 rb_equals 
-----------
 f
(1 row)

select rb_equals('{1,2,10}','{1,10,100}');
 rb_equals 
-----------
 f
(1 row)

select rb_equals('{1,10}','{1,10,100}');
 rb_equals 
-----------
 f
(1 row)

select rb_equals('{1,10,100}','{1,10,100}');
 rb_equals 
-----------
 t
(1 row)

select rb_equals('{1,10,100,10}','{1,100,10}');
 rb_equals 
-----------
 t
(1 row)

select rb_intersect(NULL,'{1,10,100}');
 rb_intersect 
--------------
 
(1 row)

select rb_intersect('{1,10,100}',NULL);
 rb_intersect 
--------------
 
(1 row)

select rb_intersect('{}','{1,10,100}');
 rb_intersect 
--------------
 f
(1 row)

select rb_intersect('{1,10,100}','{}');
 rb_intersect 
--------------
 f
(1 row)

select rb_intersect('{2}','{1,10,100}');
 rb_intersect 
--------------
 f
(1 row)

select rb_intersect('{1,2,10}','{1,10,100}');
 rb_intersect 
--------------
 t
(1 row)

select rb_intersect('{1,10}','{1,10,100}');
 rb_intersect 
--------------
 t
(1 row)

select rb_intersect('{1,10,100}','{1,10,100}');
 rb_intersect 
--------------
 t
(1 row)

select rb_intersect('{1,10,100,10}','{1,100,10}');
 rb_intersect 
--------------
 t
(1 row)

select rb_andnot(NULL,'{1,10,100}');
 rb_andnot 
-----------
 
(1 row)

select rb_andnot('{1,10,100}',NULL);
 rb_andnot 
-----------
 
(1 row)

select rb_andnot('{}','{1,10,100}');
 rb_andnot 
-----------
 {}
(1 row)

select rb_andnot('{1,10,100}','{}');
 rb_andnot  
------------
 {1,10,100}
(1 row)

select rb_andnot('{2}','{1,10,100}');
 rb_andnot 
-----------
 {2}
(1 row)

select rb_andnot('{1,2,10}','{1,10,100}');
 rb_andnot 
-----------
 {2}
(1 row)

select rb_andnot('{1,10}','{1,10,100}');
 rb_andnot 
-----------
 {}
(1 row)

select rb_andnot('{1,10,100}','{1,10,100}');
 rb_andnot 
-----------
 {}
(1 row)

select rb_andnot('{1,10,100,10}','{1,100,10}');
 rb_andnot 
-----------
 {}
(1 row)

select rb_andnot_cardinality(NULL,'{1,10,100}');
 rb_andnot_cardinality 
-----------------------
                      
(1 row)

select rb_andnot_cardinality('{1,10,100}',NULL);
 rb_andnot_cardinality 
-----------------------
                      
(1 row)

select rb_andnot_cardinality('{}','{1,10,100}');
 rb_andnot_cardinality 
-----------------------
                     0
(1 row)

select rb_andnot_cardinality('{1,10,100}','{}');
 rb_andnot_cardinality 
-----------------------
                     3
(1 row)

select rb_andnot_cardinality('{2}','{1,10,100}');
 rb_andnot_cardinality 
-----------------------
                     1
(1 row)

select rb_andnot_cardinality('{1,2,10}','{1,10,100}');
 rb_andnot_cardinality 
-----------------------
                     1
(1 row)

select rb_andnot_cardinality('{1,10}','{1,10,100}');
 rb_andnot_cardinality 
-----------------------
                     0
(1 row)

select rb_andnot_cardinality('{1,10,100}','{1,10,100}');
 rb_andnot_cardinality 
-----------------------
                     0
(1 row)

select rb_andnot_cardinality('{1,10,100,10}','{1,100,10}');
 rb_andnot_cardinality 
-----------------------
                     0
(1 row)

select rb_jaccard_dist(NULL,'{1,10,100}');
 rb_jaccard_dist 
-----------------
                
(1 row)

select rb_jaccard_dist('{1,10,100}',NULL);
 rb_jaccard_dist 
-----------------
                
(1 row)

select rb_jaccard_dist('{}','{1,10,100}');
 rb_jaccard_dist 
-----------------
               0
(1 row)

select rb_jaccard_dist('{1,10,100}','{}');
 rb_jaccard_dist 
-----------------
               0
(1 row)

select rb_jaccard_dist('{2}','{1,10,100}');
 rb_jaccard_dist 
-----------------
               0
(1 row)

select rb_jaccard_dist('{1,2,10}','{1,10,100}');
 rb_jaccard_dist 
-----------------
             0.5
(1 row)

select rb_jaccard_dist('{1,10}','{1,10,100}');
  rb_jaccard_dist  
-------------------
 0.666666666666667
(1 row)

select rb_jaccard_dist('{1,10,100}','{1,10}');
  rb_jaccard_dist  
-------------------
 0.666666666666667
(1 row)

select rb_jaccard_dist('{1,10,100}','{1,10,100}');
 rb_jaccard_dist 
-----------------
               1
(1 row)

select rb_jaccard_dist('{1,10,-100}','{1,10,-100}');
 rb_jaccard_dist 
-----------------
               1
(1 row)

select rb_jaccard_dist('{1,10,100}','{1,10,-100}');
 rb_jaccard_dist 
-----------------
             0.5
(1 row)

-- Test other functions
select rb_rank(NULL,0);
 rb_rank 
---------
        
(1 row)

select rb_rank('{}',0);
 rb_rank 
---------
       0
(1 row)

select rb_rank('{1,10,100}',0);
 rb_rank 
---------
       0
(1 row)

select rb_rank('{1,10,100}',1);
 rb_rank 
---------
       1
(1 row)

select rb_rank('{1,10,100}',99);
 rb_rank 
---------
       2
(1 row)

select rb_rank('{1,10,100}',100);
 rb_rank 
---------
       3
(1 row)

select rb_rank('{1,10,100}',101);
 rb_rank 
---------
       3
(1 row)

select rb_rank('{1,10,100,-3,-1}',-2);
 rb_rank 
---------
       4
(1 row)

select rb_remove(NULL,0);
 rb_remove 
-----------
 
(1 row)

select rb_remove('{}',0);
 rb_remove 
-----------
 {}
(1 row)

select rb_remove('{1}',1);
 rb_remove 
-----------
 {}
(1 row)

select rb_remove('{1,10,100}',0);
 rb_remove  
------------
 {1,10,100}
(1 row)

select rb_remove('{1,10,100}',1);
 rb_remove 
-----------
 {10,100}
(1 row)

select rb_remove('{1,10,100}',99);
 rb_remove  
------------
 {1,10,100}
(1 row)

select rb_fill(NULL,0,0);
 rb_fill 
---------
 
(1 row)

select rb_fill('{}',0,0);
 rb_fill 
---------
 {}
(1 row)

select rb_fill('{}',0,1);
 rb_fill 
---------
 {0}
(1 row)

select rb_fill('{}',0,2);
 rb_fill 
---------
 {0,1}
(1 row)

select rb_fill('{1,10,100}',10,10);
  rb_fill   
------------
 {1,10,100}
(1 row)

select rb_fill('{1,10,100}',10,11);
  rb_fill   
------------
 {1,10,100}
(1 row)

select rb_fill('{1,10,100}',10,12);
    rb_fill    
---------------
 {1,10,11,100}
(1 row)

select rb_fill('{1,10,100}',10,13);
     rb_fill      
------------------
 {1,10,11,12,100}
(1 row)

select rb_fill('{1,10,100}',10,20);
                rb_fill                
---------------------------------------
 {1,10,11,12,13,14,15,16,17,18,19,100}
(1 row)

select rb_fill('{1,10,100}',0,-1);
  rb_fill   
------------
 {1,10,100}
(1 row)

select rb_cardinality(rb_fill('{1,10,100}',2,1000000000));
 rb_cardinality 
----------------
      999999999
(1 row)

select rb_cardinality(rb_fill('{1,10,100}',-1,5000000000));
 rb_cardinality 
----------------
          65536
(1 row)

select rb_index(NULL,3);
 rb_index 
----------
         
(1 row)

select rb_index('{1,2,3}',NULL);
 rb_index 
----------
         
(1 row)

select rb_index('{}',3);
 rb_index 
----------
       -1
(1 row)

select rb_index('{1}',3);
 rb_index 
----------
       -1
(1 row)

select rb_index('{1}',1);
 rb_index 
----------
        0
(1 row)

select rb_index('{1,10,100}',10);
 rb_index 
----------
        1
(1 row)

select rb_index('{1,10,100}',99);
 rb_index 
----------
       -1
(1 row)

select rb_index('{1,10,-100}',-100);
 rb_index 
----------
        2
(1 row)

select rb_clear(NULL,0,10);
 rb_clear 
----------
 
(1 row)

select rb_clear('{}',0,10);
 rb_clear 
----------
 {}
(1 row)

select rb_clear('{1,10,100}',0,10);
 rb_clear 
----------
 {10,100}
(1 row)

select rb_clear('{1,10,100}',3,3);
  rb_clear  
------------
 {1,10,100}
(1 row)

select rb_clear('{1,10,100}',-3,3);
 rb_clear 
----------
 {10,100}
(1 row)

select rb_clear('{1,10,100}',0,-1);
  rb_clear  
------------
 {1,10,100}
(1 row)

select rb_clear('{1,10,100}',9,9);
  rb_clear  
------------
 {1,10,100}
(1 row)

select rb_clear('{1,10,100}',2,1000000000);
 rb_clear 
----------
 {1}
(1 row)

select rb_clear('{0,1,10,100,-2,-1}',1,4294967295);
 rb_clear 
----------
 {0,-1}
(1 row)

select rb_clear('{0,1,10,100,-2,-1}',0,4294967296);
 rb_clear 
----------
 {}
(1 row)

select rb_flip(NULL,0,10);
 rb_flip 
---------
 
(1 row)

select rb_flip('{}',0,10);
        rb_flip        
-----------------------
 {0,1,2,3,4,5,6,7,8,9}
(1 row)

select rb_flip('{1,10,100}',9,100);
                                                                                                                                       rb_flip                                                                                                                                        
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {1,9,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100}
(1 row)

select rb_flip('{1,10,100}',10,101);
                                                                                                                                    rb_flip                                                                                                                                     
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {1,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99}
(1 row)

select rb_flip('{1,10,100}',-3,3);
   rb_flip    
--------------
 {0,2,10,100}
(1 row)

select rb_flip('{1,10,100}',0,-1);
  rb_flip   
------------
 {1,10,100}
(1 row)

select rb_flip('{1,10,100}',9,9);
  rb_flip   
------------
 {1,10,100}
(1 row)

select rb_cardinality(rb_flip('{1,10,100}',2,1000000000));
 rb_cardinality 
----------------
      999999997
(1 row)

select rb_cardinality(rb_flip('{1,10,100}',-1,5000000000));
 rb_cardinality 
----------------
     4294967293
(1 row)

select rb_range(NULL,0,10);
 rb_range 
----------
 
(1 row)

select rb_range('{}',0,10);
 rb_range 
----------
 {}
(1 row)

select rb_range('{1,10,100}',0,10);
 rb_range 
----------
 {1}
(1 row)

select rb_range('{1,10,100}',3,3);
 rb_range 
----------
 {}
(1 row)

select rb_range('{1,10,100}',-3,3);
 rb_range 
----------
 {1}
(1 row)

select rb_range('{1,10,100}',0,-1);
 rb_range 
----------
 {}
(1 row)

select rb_range('{1,10,100}',9,9);
 rb_range 
----------
 {}
(1 row)

select rb_range('{1,10,100}',2,1000000000);
 rb_range 
----------
 {10,100}
(1 row)

select rb_range('{0,1,10,100,-2,-1}',1,4294967295);
   rb_range    
---------------
 {1,10,100,-2}
(1 row)

select rb_range('{0,1,10,100,-2,-1}',0,4294967296);
      rb_range      
--------------------
 {0,1,10,100,-2,-1}
(1 row)

select rb_range_cardinality(NULL,0,10);
 rb_range_cardinality 
----------------------
                     
(1 row)

select rb_range_cardinality('{}',0,10);
 rb_range_cardinality 
----------------------
                    0
(1 row)

select rb_range_cardinality('{1,10,100}',0,10);
 rb_range_cardinality 
----------------------
                    1
(1 row)

select rb_range_cardinality('{1,10,100}',3,3);
 rb_range_cardinality 
----------------------
                    0
(1 row)

select rb_range_cardinality('{1,10,100}',-3,3);
 rb_range_cardinality 
----------------------
                    1
(1 row)

select rb_range_cardinality('{1,10,100}',0,-1);
 rb_range_cardinality 
----------------------
                    0
(1 row)

select rb_range_cardinality('{1,10,100}',9,9);
 rb_range_cardinality 
----------------------
                    0
(1 row)

select rb_range_cardinality('{1,10,100}',2,1000000000);
 rb_range_cardinality 
----------------------
                    2
(1 row)

select rb_range_cardinality('{0,1,10,100,-2,-1}',1,4294967295);
 rb_range_cardinality 
----------------------
                    4
(1 row)

select rb_range_cardinality('{0,1,10,100,-2,-1}',0,4294967296);
 rb_range_cardinality 
----------------------
                    6
(1 row)

select rb_select(NULL,10);
 rb_select 
-----------
 
(1 row)

select rb_select('{}',10);
 rb_select 
-----------
 {}
(1 row)

select rb_select('{0,1,2,10,100,1000,2147483647,-2147483648,-2,-1}',0);
 rb_select 
-----------
 {}
(1 row)

select rb_select('{0,1,2,10,100,1000,2147483647,-2147483648,-2,-1}',1);
 rb_select 
-----------
 {0}
(1 row)

select rb_select('{0,1,2,10,100,1000,2147483647,-2147483648,-2,-1}',2);
 rb_select 
-----------
 {0,1}
(1 row)

select rb_select('{0,1,2,10,100,1000,2147483647,-2147483648,-2,-1}',2,0);
 rb_select 
-----------
 {0,1}
(1 row)

select rb_select('{0,1,2,10,100,1000,2147483647,-2147483648,-2,-1}',2,1);
 rb_select 
-----------
 {1,2}
(1 row)

select rb_select('{0,1,2,10,100,1000,2147483647,-2147483648,-2,-1}',2,1,true);
    rb_select     
------------------
 {-2147483648,-2}
(1 row)

select rb_select('{0,1,2,10,100,1000,2147483647,-2147483648,-2,-1}',2,1,true,9);
    rb_select     
------------------
 {-2147483648,-2}
(1 row)

select rb_select('{0,1,2,10,100,1000,2147483647,-2147483648,-2,-1}',2,1,true,9,4294967295);
        rb_select         
--------------------------
 {2147483647,-2147483648}
(1 row)

select rb_select('{0,1,2,10,100,1000,2147483647,-2147483648,-2,-1}',2,1,false);
 rb_select 
-----------
 {1,2}
(1 row)

select rb_select('{0,1,2,10,100,1000,2147483647,-2147483648,-2,-1}',2,1,false,9);
 rb_select  
------------
 {100,1000}
(1 row)

select rb_select('{0,1,2,10,100,1000,2147483647,-2147483648,-2,-1}',2,1,false,10);
 rb_select  
------------
 {100,1000}
(1 row)

select rb_select('{0,1,2,10,100,1000,2147483647,-2147483648,-2,-1}',2,1,false,10,10);
 rb_select 
-----------
 {}
(1 row)

select rb_select('{0,1,2,10,100,1000,2147483647,-2147483648,-2,-1}',2,1,false,-10,100);
 rb_select 
-----------
 {1,2}
(1 row)

select rb_select('{0,1,2,10,100,1000,2147483647,-2147483648,-2,-1}',2,1,false,-10,-10);
 rb_select 
-----------
 {}
(1 row)

select rb_select('{0,1,2,10,100,1000,2147483647,-2147483648,-2,-1}',2,1,false,10,10001);
 rb_select  
------------
 {100,1000}
(1 row)

select rb_select('{0,1,2,10,100,1000,2147483647,-2147483648,-2,-1}',2,1,true,10,10001);
 rb_select 
-----------
 {10,100}
(1 row)

-- Test aggregate
select rb_and_agg(id) from (values (NULL::roaringbitmap)) t(id);
 rb_and_agg 
------------
 
(1 row)

select rb_and_agg(id) from (values (roaringbitmap('{}'))) t(id);
 rb_and_agg 
------------
 {}
(1 row)

select rb_and_agg(id) from (values (roaringbitmap('{1}'))) t(id);
 rb_and_agg 
------------
 {1}
(1 row)

select rb_and_agg(id) from (values (roaringbitmap('{1,10,100}'))) t(id);
 rb_and_agg 
------------
 {1,10,100}
(1 row)

select rb_and_agg(id) from (values (roaringbitmap('{1,10,100}')),(roaringbitmap('{2,10}'))) t(id);
 rb_and_agg 
------------
 {10}
(1 row)

select rb_and_agg(id) from (values (roaringbitmap('{1,10,100}')),(roaringbitmap('{1,10,100}'))) t(id);
 rb_and_agg 
------------
 {1,10,100}
(1 row)

select rb_and_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(roaringbitmap('{}'))) t(id);
 rb_and_agg 
------------
 {}
(1 row)

select rb_and_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(roaringbitmap('{1}'))) t(id);
 rb_and_agg 
------------
 {1}
(1 row)

select rb_and_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(roaringbitmap('{2}'))) t(id);
 rb_and_agg 
------------
 {}
(1 row)

select rb_and_agg(id) from (values (roaringbitmap('{1,10,100}')),(NULL),(roaringbitmap('{2,10}'))) t(id);
 rb_and_agg 
------------
 {10}
(1 row)

select rb_and_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(NULL),(roaringbitmap('{1,10,100,101}')),(NULL)) t(id);
 rb_and_agg 
------------
 {1,10,100}
(1 row)

select rb_and_cardinality_agg(id) from (values (NULL::roaringbitmap)) t(id);
 rb_and_cardinality_agg 
------------------------
                       
(1 row)

select rb_and_cardinality_agg(id) from (values (roaringbitmap('{}'))) t(id);
 rb_and_cardinality_agg 
------------------------
                      0
(1 row)

select rb_and_cardinality_agg(id) from (values (roaringbitmap('{1}'))) t(id);
 rb_and_cardinality_agg 
------------------------
                      1
(1 row)

select rb_and_cardinality_agg(id) from (values (roaringbitmap('{1,10,100}'))) t(id);
 rb_and_cardinality_agg 
------------------------
                      3
(1 row)

select rb_and_cardinality_agg(id) from (values (roaringbitmap('{1,10,100}')),(roaringbitmap('{2,10}'))) t(id);
 rb_and_cardinality_agg 
------------------------
                      1
(1 row)

select rb_and_cardinality_agg(id) from (values (roaringbitmap('{1,10,100}')),(roaringbitmap('{1,10,100}'))) t(id);
 rb_and_cardinality_agg 
------------------------
                      3
(1 row)

select rb_and_cardinality_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(roaringbitmap('{}'))) t(id);
 rb_and_cardinality_agg 
------------------------
                      0
(1 row)

select rb_and_cardinality_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(roaringbitmap('{1}'))) t(id);
 rb_and_cardinality_agg 
------------------------
                      1
(1 row)

select rb_and_cardinality_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(roaringbitmap('{2}'))) t(id);
 rb_and_cardinality_agg 
------------------------
                      0
(1 row)

select rb_and_cardinality_agg(id) from (values (roaringbitmap('{1,10,100}')),(NULL),(roaringbitmap('{2,10}'))) t(id);
 rb_and_cardinality_agg 
------------------------
                      1
(1 row)

select rb_and_cardinality_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(NULL),(roaringbitmap('{1,10,100,101}')),(NULL)) t(id);
 rb_and_cardinality_agg 
------------------------
                      3
(1 row)

select rb_or_agg(id) from (values (NULL::roaringbitmap)) t(id);
 rb_or_agg 
-----------
 
(1 row)

select rb_or_agg(id) from (values (roaringbitmap('{}'))) t(id);
 rb_or_agg 
-----------
 {}
(1 row)

select rb_or_agg(id) from (values (roaringbitmap('{1}'))) t(id);
 rb_or_agg 
-----------
 {1}
(1 row)

select rb_or_agg(id) from (values (roaringbitmap('{1,10,100}'))) t(id);
 rb_or_agg  
------------
 {1,10,100}
(1 row)

select rb_or_agg(id) from (values (roaringbitmap('{1,10,100}')),(roaringbitmap('{2,10}'))) t(id);
  rb_or_agg   
--------------
 {1,2,10,100}
(1 row)

select rb_or_agg(id) from (values (roaringbitmap('{1,10,100}')),(roaringbitmap('{1,10,100}'))) t(id);
 rb_or_agg  
------------
 {1,10,100}
(1 row)

select rb_or_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(roaringbitmap('{}'))) t(id);
 rb_or_agg  
------------
 {1,10,100}
(1 row)

select rb_or_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(roaringbitmap('{1}'))) t(id);
 rb_or_agg  
------------
 {1,10,100}
(1 row)

select rb_or_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(roaringbitmap('{2}'))) t(id);
  rb_or_agg   
--------------
 {1,2,10,100}
(1 row)

select rb_or_agg(id) from (values (roaringbitmap('{1,10,100}')),(NULL),(roaringbitmap('{2,10}'))) t(id);
  rb_or_agg   
--------------
 {1,2,10,100}
(1 row)

select rb_or_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(NULL),(roaringbitmap('{1,10,100,101}')),(NULL)) t(id);
   rb_or_agg    
----------------
 {1,10,100,101}
(1 row)

select rb_or_cardinality_agg(id) from (values (NULL::roaringbitmap)) t(id);
 rb_or_cardinality_agg 
-----------------------
                      
(1 row)

select rb_or_cardinality_agg(id) from (values (roaringbitmap('{}'))) t(id);
 rb_or_cardinality_agg 
-----------------------
                     0
(1 row)

select rb_or_cardinality_agg(id) from (values (roaringbitmap('{1}'))) t(id);
 rb_or_cardinality_agg 
-----------------------
                     1
(1 row)

select rb_or_cardinality_agg(id) from (values (roaringbitmap('{1,10,100}'))) t(id);
 rb_or_cardinality_agg 
-----------------------
                     3
(1 row)

select rb_or_cardinality_agg(id) from (values (roaringbitmap('{1,10,100}')),(roaringbitmap('{2,10}'))) t(id);
 rb_or_cardinality_agg 
-----------------------
                     4
(1 row)

select rb_or_cardinality_agg(id) from (values (roaringbitmap('{1,10,100}')),(roaringbitmap('{1,10,100}'))) t(id);
 rb_or_cardinality_agg 
-----------------------
                     3
(1 row)

select rb_or_cardinality_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(roaringbitmap('{}'))) t(id);
 rb_or_cardinality_agg 
-----------------------
                     3
(1 row)

select rb_or_cardinality_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(roaringbitmap('{1}'))) t(id);
 rb_or_cardinality_agg 
-----------------------
                     3
(1 row)

select rb_or_cardinality_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(roaringbitmap('{2}'))) t(id);
 rb_or_cardinality_agg 
-----------------------
                     4
(1 row)

select rb_or_cardinality_agg(id) from (values (roaringbitmap('{1,10,100}')),(NULL),(roaringbitmap('{2,10}'))) t(id);
 rb_or_cardinality_agg 
-----------------------
                     4
(1 row)

select rb_or_cardinality_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(NULL),(roaringbitmap('{1,10,100,101}')),(NULL)) t(id);
 rb_or_cardinality_agg 
-----------------------
                     4
(1 row)

select rb_xor_agg(id) from (values (NULL::roaringbitmap)) t(id);
 rb_xor_agg 
------------
 
(1 row)

select rb_xor_agg(id) from (values (roaringbitmap('{}'))) t(id);
 rb_xor_agg 
------------
 {}
(1 row)

select rb_xor_agg(id) from (values (roaringbitmap('{1}'))) t(id);
 rb_xor_agg 
------------
 {1}
(1 row)

select rb_xor_agg(id) from (values (roaringbitmap('{1,10,100}'))) t(id);
 rb_xor_agg 
------------
 {1,10,100}
(1 row)

select rb_xor_agg(id) from (values (roaringbitmap('{1,10,100}')),(roaringbitmap('{2,10}'))) t(id);
 rb_xor_agg 
------------
 {1,2,100}
(1 row)

select rb_xor_agg(id) from (values (roaringbitmap('{1,10,100}')),(roaringbitmap('{1,10,100}'))) t(id);
 rb_xor_agg 
------------
 {}
(1 row)

select rb_xor_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(roaringbitmap('{}'))) t(id);
 rb_xor_agg 
------------
 {1,10,100}
(1 row)

select rb_xor_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(roaringbitmap('{1}'))) t(id);
 rb_xor_agg 
------------
 {10,100}
(1 row)

select rb_xor_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(roaringbitmap('{2}'))) t(id);
  rb_xor_agg  
--------------
 {1,2,10,100}
(1 row)

select rb_xor_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(roaringbitmap('{2,10}'))) t(id);
 rb_xor_agg 
------------
 {1,2,100}
(1 row)

select rb_xor_agg(id) from (values (roaringbitmap('{1,10,100}')),(NULL),(roaringbitmap('{1,10,100,101}'))) t(id);
 rb_xor_agg 
------------
 {101}
(1 row)

select rb_xor_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(NULL),(roaringbitmap('{1,10,101}')),(roaringbitmap('{1,100,102}')),(NULL)) t(id);
 rb_xor_agg  
-------------
 {1,101,102}
(1 row)

select rb_xor_cardinality_agg(id) from (values (NULL::roaringbitmap)) t(id);
 rb_xor_cardinality_agg 
------------------------
                       
(1 row)

select rb_xor_cardinality_agg(id) from (values (roaringbitmap('{}'))) t(id);
 rb_xor_cardinality_agg 
------------------------
                      0
(1 row)

select rb_xor_cardinality_agg(id) from (values (roaringbitmap('{1}'))) t(id);
 rb_xor_cardinality_agg 
------------------------
                      1
(1 row)

select rb_xor_cardinality_agg(id) from (values (roaringbitmap('{1,10,100}'))) t(id);
 rb_xor_cardinality_agg 
------------------------
                      3
(1 row)

select rb_xor_cardinality_agg(id) from (values (roaringbitmap('{1,10,100}')),(roaringbitmap('{2,10}'))) t(id);
 rb_xor_cardinality_agg 
------------------------
                      3
(1 row)

select rb_xor_cardinality_agg(id) from (values (roaringbitmap('{1,10,100}')),(roaringbitmap('{1,10,100}'))) t(id);
 rb_xor_cardinality_agg 
------------------------
                      0
(1 row)

select rb_xor_cardinality_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(roaringbitmap('{}'))) t(id);
 rb_xor_cardinality_agg 
------------------------
                      3
(1 row)

select rb_xor_cardinality_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(roaringbitmap('{1}'))) t(id);
 rb_xor_cardinality_agg 
------------------------
                      2
(1 row)

select rb_xor_cardinality_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(roaringbitmap('{2}'))) t(id);
 rb_xor_cardinality_agg 
------------------------
                      4
(1 row)

select rb_xor_cardinality_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(roaringbitmap('{2,10}'))) t(id);
 rb_xor_cardinality_agg 
------------------------
                      3
(1 row)

select rb_xor_cardinality_agg(id) from (values (roaringbitmap('{1,10,100}')),(NULL),(roaringbitmap('{1,10,100,101}'))) t(id);
 rb_xor_cardinality_agg 
------------------------
                      1
(1 row)

select rb_xor_cardinality_agg(id) from (values (NULL),(roaringbitmap('{1,10,100}')),(NULL),(roaringbitmap('{1,10,101}')),(roaringbitmap('{1,100,102}')),(NULL)) t(id);
 rb_xor_cardinality_agg 
------------------------
                      3
(1 row)

select rb_build_agg(id) from (values (NULL::int)) t(id);
 rb_build_agg 
--------------
 
(1 row)

select rb_build_agg(id) from (values (1)) t(id);
 rb_build_agg 
--------------
 {1}
(1 row)

select rb_build_agg(id) from (values (1),(10)) t(id);
 rb_build_agg 
--------------
 {1,10}
(1 row)

select rb_build_agg(id) from (values (1),(10),(10),(100),(1)) t(id);
 rb_build_agg 
--------------
 {1,10,100}
(1 row)

-- Test parallel aggregate
set max_parallel_workers=8;
set max_parallel_workers_per_gather=2;
set parallel_setup_cost=0;
set parallel_tuple_cost=0;
set min_parallel_table_scan_size=0;
create table if not exists bitmap_test_tb1(id int, bitmap roaringbitmap);
insert into bitmap_test_tb1 values (NULL,NULL);
insert into bitmap_test_tb1 select id,rb_build(ARRAY[id]) from generate_series(1,10000)id;
insert into bitmap_test_tb1 values (NULL,NULL);
insert into bitmap_test_tb1 values (10001,rb_build(ARRAY[10,100,1000,10000,10001]));
explain(costs off) 
with a as
(
select rb_build_agg(id) bitmap from bitmap_test_tb1
)
select rb_cardinality(bitmap),rb_min(bitmap),rb_max(bitmap) from a;
                           QUERY PLAN                           
----------------------------------------------------------------
 CTE Scan on a
   CTE a
     ->  Finalize Aggregate
           ->  Gather
                 Workers Planned: 2
                 ->  Partial Aggregate
                       ->  Parallel Seq Scan on bitmap_test_tb1
(7 rows)

with a as
(
select rb_build_agg(id) bitmap from bitmap_test_tb1
)
select rb_cardinality(bitmap),rb_min(bitmap),rb_max(bitmap) from a;
 rb_cardinality | rb_min | rb_max 
----------------+--------+--------
          10001 |      1 |  10001
(1 row)

explain(costs off) 
with a as
(
select rb_and_agg(bitmap) bitmap from bitmap_test_tb1
)
select rb_cardinality(bitmap),rb_min(bitmap),rb_max(bitmap) from a;
                           QUERY PLAN                           
----------------------------------------------------------------
 CTE Scan on a
   CTE a
     ->  Finalize Aggregate
           ->  Gather
                 Workers Planned: 2
                 ->  Partial Aggregate
                       ->  Parallel Seq Scan on bitmap_test_tb1
(7 rows)

with a as
(
select rb_and_agg(bitmap) bitmap from bitmap_test_tb1
)
select rb_cardinality(bitmap),rb_min(bitmap),rb_max(bitmap) from a;
 rb_cardinality | rb_min | rb_max 
----------------+--------+--------
              0 |        |       
(1 row)

explain(costs off) 
with a as
(
select rb_or_agg(bitmap) bitmap from bitmap_test_tb1
)
select rb_cardinality(bitmap),rb_min(bitmap),rb_max(bitmap) from a;
                           QUERY PLAN                           
----------------------------------------------------------------
 CTE Scan on a
   CTE a
     ->  Finalize Aggregate
           ->  Gather
                 Workers Planned: 2
                 ->  Partial Aggregate
                       ->  Parallel Seq Scan on bitmap_test_tb1
(7 rows)

with a as
(
select rb_or_agg(bitmap) bitmap from bitmap_test_tb1
)
select rb_cardinality(bitmap),rb_min(bitmap),rb_max(bitmap) from a;
 rb_cardinality | rb_min | rb_max 
----------------+--------+--------
          10001 |      1 |  10001
(1 row)

explain(costs off) 
with a as
(
select rb_xor_agg(bitmap) bitmap from bitmap_test_tb1
)
select rb_cardinality(bitmap),rb_min(bitmap),rb_max(bitmap) from a;
                           QUERY PLAN                           
----------------------------------------------------------------
 CTE Scan on a
   CTE a
     ->  Finalize Aggregate
           ->  Gather
                 Workers Planned: 2
                 ->  Partial Aggregate
                       ->  Parallel Seq Scan on bitmap_test_tb1
(7 rows)

with a as
(
select rb_xor_agg(bitmap) bitmap from bitmap_test_tb1
)
select rb_cardinality(bitmap),rb_min(bitmap),rb_max(bitmap) from a;
 rb_cardinality | rb_min | rb_max 
----------------+--------+--------
           9997 |      1 |  10001
(1 row)

explain(costs off)
select rb_and_cardinality_agg(bitmap),rb_or_cardinality_agg(bitmap),rb_xor_cardinality_agg(bitmap) from bitmap_test_tb1;
                    QUERY PLAN                    
--------------------------------------------------
 Aggregate
   ->  Gather
         Workers Planned: 2
         ->  Parallel Seq Scan on bitmap_test_tb1
(4 rows)

select rb_and_cardinality_agg(bitmap),rb_or_cardinality_agg(bitmap),rb_xor_cardinality_agg(bitmap) from bitmap_test_tb1;
 rb_and_cardinality_agg | rb_or_cardinality_agg | rb_xor_cardinality_agg 
------------------------+-----------------------+------------------------
                      0 |                 10001 |                   9997
(1 row)

